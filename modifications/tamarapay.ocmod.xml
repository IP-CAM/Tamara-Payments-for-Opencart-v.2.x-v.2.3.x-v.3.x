<modification>
    <name>Tamara payment</name>
    <version>1.2.0</version>
    <link>https://tamara.co/en/index.html#how-it-works</link>
    <author>Tamara</author>
    <code>tamarapay</code>
    <file path="catalog/controller/product/product.php">
        <operation>
            <search><![CDATA[$data['recurrings'] = $this->model_catalog_product->getProfiles($this->request->get['product_id']);]]>
            </search>
            <add position="after">
                <![CDATA[
                $this->load->model('payment/tamarapay');
                $finalPrice = 0.00;
                if ((float)$product_info['special']) {
                    $finalPrice = $this->tax->calculate($product_info['special'], $product_info['tax_class_id'], $this->config->get('config_tax'));
                } else {
                    if ($this->customer->isLogged() || !$this->config->get('config_customer_price')) {
                        $finalPrice = $this->tax->calculate($product_info['price'], $product_info['tax_class_id'], $this->config->get('config_tax'));
                    }
                }
                $availableMethods = $this->model_payment_tamarapay->getPaymentsMethodsAvailableForPrice($finalPrice);
                $data['tamara_available_methods'] = $availableMethods;
                $data['final_price'] = $finalPrice;
                $data['language_code'] = $this->language->get('code');
				]]></add>
        </operation>
    </file>
    <file path="catalog/view/theme/*/template/product/product.tpl">
        <operation>
            <search><![CDATA[<div id="product">]]>
            </search>
            <add position="before">
                <![CDATA[
				<?php if (!empty($tamara_available_methods)): ?>
                  <?php foreach($tamara_available_methods as $method): ?>
                    <?php if ($method['checked'] == true): ?>
                      <?php if($method['name'] == "PAY_BY_INSTALMENTS"): ?>
                        <a href="javascript:void(0)" id="tamara-product-widget" data-disable-paylater="true" class="tamara-product-widget" data-lang="" data-price="<?php echo $final_price ?>" data-currency="<?php echo $method['currency'] ?>" data-payment-type="installment" data-installment-minimum-amount="<?php echo $method['min_limit'] ?>" ></a>
                      <?php else: ?>
                        <a href="javascript:void(0)" id="tamara-product-widget" data-payment-type="paylater" data-disable-installment="true" class="tamara-product-widget" data-lang="" data-inject-template="true"></a>
                      <?php endif; ?>
                      <?php break; ?>
                    <?php endif; ?>
                  <?php endforeach; ?>

                  <script charset="utf-8" src="https://cdn.tamara.co/widget/product-widget.min.js"></script>
                  <script type="text/javascript">
                    let siteLocale = '<?php echo $language_code ?>';
                    let langCode = siteLocale.split('-')[0];
                    window.checkTamaraProductWidgetCount = 0;
                    document.getElementById('tamara-product-widget').setAttribute("data-lang", langCode);
                    var existTamaraProductWidget = setInterval(function() {
                      if (window.TamaraProductWidget) {
                        window.TamaraProductWidget.init({ lang: window.langCode });
                        window.TamaraProductWidget.render();
                        clearInterval(existTamaraProductWidget);
                      }
                      window.checkTamaraProductWidgetCount += 1;
                      if (window.checkTamaraProductWidgetCount > 15) {
                        clearInterval(existTamaraProductWidget);
                      }
                    }, 300);
                  </script>
                <?php endif; ?>
				]]></add>
        </operation>
    </file>
</modification>